{
  "name": "misra-escalation",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "misra-escalation",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "node-webhook",
      "name": "Webhook (nightly_build í˜¸ì¶œ)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300],
      "webhookId": "misra-escalation-webhook"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nconst errorLog   = body.error_log   || 'ì—ëŸ¬ ë¡œê·¸ ì—†ìŒ';\nconst failReason = body.fail_reason || 'ì›ì¸ ë¶ˆëª…';\nconst project    = body.project     || '{{ $env.PROJECT_PATH }}';\nconst board      = body.board_type  || '{{ $env.BOARD_TYPE }}';\n\nconst prompt = `ì•¼ê°„ ë¹Œë“œì—ì„œ Gate 2 (Static Analysis) ê°€ ì‹¤íŒ¨í–ˆì–´.\\n\\nì‹¤íŒ¨ ì›ì¸: ${failReason}\\ní”„ë¡œì íŠ¸: ${project}\\n\\ncppcheck ì—ëŸ¬ ë¡œê·¸:\\n\\`\\`\\`\\n${errorLog}\\n\\`\\`\\`\\n\\në‹¤ìŒ ìˆœì„œë¡œ ì²˜ë¦¬í•´ì¤˜:\\n1. ìœ„ë°˜ í•­ëª©ì„ Mandatory / Advisory / ê±°ì§“ì–‘ì„±ìœ¼ë¡œ ë¶„ë¥˜\\n2. ì‹¤ì œ ë²„ê·¸ ê°€ëŠ¥ì„± í•­ëª©ì€ @developerì—ê²Œ ìˆ˜ì • ìš”ì²­\\n3. ì–µì œ ê°€ëŠ¥í•œ í•­ëª©ì€ ì •ë‹¹í™” ì£¼ì„ ì¶”ê°€ í›„ ì–µì œ\\n4. ì²˜ë¦¬ ì™„ë£Œ í›„ ê²°ê³¼ ìš”ì•½ ë³´ê³ `;\n\nreturn [{ json: { prompt, errorLog, failReason, project, board, attempt: 1 } }];"
      },
      "id": "node-prepare-misra",
      "name": "MISRA ìš”ì²­ ì¤€ë¹„",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [420, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:8080/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type",  "value": "application/json" },
            { "name": "Authorization", "value": "Bearer dummy" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"misra-agent\",\n  \"messages\": [{\"role\": \"user\", \"content\": \"{{ $json.prompt }}\"}],\n  \"stream\": false\n}",
        "options": { "timeout": 300000 }
      },
      "id": "node-misra-attempt1",
      "name": "@misra-agent 1ì°¨ ì‹œë„",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [640, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst content = response?.choices?.[0]?.message?.content || '';\n\n// ìˆ˜ì •/ì–µì œ ì™„ë£Œ ì—¬ë¶€ íŒë‹¨\nconst resolved = /ì™„ë£Œ|PASS|í†µê³¼|ì²˜ë¦¬ ì™„ë£Œ|Gate 2.*pass/i.test(content);\n\nreturn [{ json: { content, resolved, attempt: 1 } }];"
      },
      "id": "node-check-attempt1",
      "name": "1ì°¨ ê²°ê³¼ í™•ì¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 300]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "check-resolved",
              "leftValue": "={{ $json.resolved }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "true" }
            }
          ]
        }
      },
      "id": "node-resolved1",
      "name": "1ì°¨ í•´ê²°?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1080, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:8080/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type",  "value": "application/json" },
            { "name": "Authorization", "value": "Bearer dummy" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"misra-agent\",\n  \"messages\": [\n    {\"role\": \"user\",      \"content\": \"{{ $('MISRA ìš”ì²­ ì¤€ë¹„').item.json.prompt }}\"},\n    {\"role\": \"assistant\", \"content\": \"{{ $('1ì°¨ ê²°ê³¼ í™•ì¸').item.json.content }}\"},\n    {\"role\": \"user\",      \"content\": \"ì•„ì§ Gate 2ê°€ í†µê³¼ë˜ì§€ ì•Šì•˜ì–´. ë‚¨ì€ ìœ„ë°˜ í•­ëª©ì„ ë‹¤ì‹œ ë¶„ì„í•´ì„œ ì™„ì „íˆ ì²˜ë¦¬í•´ì¤˜. Gate 2 PASS ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ì§„í–‰í•´ì¤˜.\"}\n  ],\n  \"stream\": false\n}",
        "options": { "timeout": 300000 }
      },
      "id": "node-misra-attempt2",
      "name": "@misra-agent 2ì°¨ ì‹œë„",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1300, 400]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst content = response?.choices?.[0]?.message?.content || '';\nconst resolved = /ì™„ë£Œ|PASS|í†µê³¼|ì²˜ë¦¬ ì™„ë£Œ|Gate 2.*pass/i.test(content);\nreturn [{ json: { content, resolved, attempt: 2 } }];"
      },
      "id": "node-check-attempt2",
      "name": "2ì°¨ ê²°ê³¼ í™•ì¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1520, 400]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "check-resolved2",
              "leftValue": "={{ $json.resolved }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "true" }
            }
          ]
        }
      },
      "id": "node-resolved2",
      "name": "2ì°¨ í•´ê²°?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1740, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:8080/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type",  "value": "application/json" },
            { "name": "Authorization", "value": "Bearer dummy" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"architect\",\n  \"messages\": [{\n    \"role\": \"user\",\n    \"content\": \"@misra-agentê°€ Gate 2 ì‹¤íŒ¨ë¥¼ 2íšŒ ì‹œë„í–ˆì§€ë§Œ í•´ê²°í•˜ì§€ ëª»í–ˆì–´.\\n\\ní”„ë¡œì íŠ¸: {{ $('MISRA ìš”ì²­ ì¤€ë¹„').item.json.project }}\\n\\n1ì°¨ ì‹œë„ ê²°ê³¼:\\n{{ $('1ì°¨ ê²°ê³¼ í™•ì¸').item.json.content.substring(0,500) }}\\n\\n2ì°¨ ì‹œë„ ê²°ê³¼:\\n{{ $('2ì°¨ ê²°ê³¼ í™•ì¸').item.json.content.substring(0,500) }}\\n\\nì›ë³¸ ì—ëŸ¬:\\n{{ $('MISRA ìš”ì²­ ì¤€ë¹„').item.json.errorLog.substring(0,500) }}\\n\\nê·¼ë³¸ ì›ì¸ì„ ë¶„ì„í•˜ê³  í•´ê²° ë°©í–¥ì„ ì œì‹œí•´ì¤˜. í•„ìš”í•˜ë©´ @geminiì—ê²Œ ìµœì‹  ë¬¸ì„œ ê²€ìƒ‰ì„ ìš”ì²­í•´.\"\n  }],\n  \"stream\": false\n}",
        "options": { "timeout": 600000 }
      },
      "id": "node-architect-escalation",
      "name": "@architect ì—ìŠ¤ì»¬ë ˆì´ì…˜",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1960, 500]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "âœ… *MISRA Gate 2 í•´ê²° ì™„ë£Œ*\n\në‹´ë‹¹: @misra-agent ({{ $json.attempt }}ì°¨ ì‹œë„)\n\nì²˜ë¦¬ ê²°ê³¼:\n{{ $json.content.substring(0, 600) }}",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "node-telegram-resolved",
      "name": "Telegram í•´ê²° ì•Œë¦¼",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1300, 200],
      "credentials": { "telegramApi": { "id": "telegram-cred", "name": "Telegram Bot" } }
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "ğŸš¨ *MISRA ì—ìŠ¤ì»¬ë ˆì´ì…˜ â€” @architect ê°œì…*\n\n@misra-agent 2íšŒ ëª¨ë‘ ì‹¤íŒ¨\n\nğŸ›ï¸ *@architect ë¶„ì„:*\n{{ $json.choices[0].message.content.substring(0, 700) }}\n\nğŸ“‹ ë¡œê·¸: `/tmp/nightly_build_*.log`",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "node-telegram-escalation",
      "name": "Telegram ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì•Œë¦¼",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [2180, 500],
      "credentials": { "telegramApi": { "id": "telegram-cred", "name": "Telegram Bot" } }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"status\": \"received\", \"workflow\": \"misra-escalation\" }"
      },
      "id": "node-webhook-response",
      "name": "Webhook ì‘ë‹µ",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [420, 500]
    }
  ],
  "connections": {
    "Webhook (nightly_build í˜¸ì¶œ)": {
      "main": [
        [
          { "node": "MISRA ìš”ì²­ ì¤€ë¹„",  "type": "main", "index": 0 },
          { "node": "Webhook ì‘ë‹µ",     "type": "main", "index": 0 }
        ]
      ]
    },
    "MISRA ìš”ì²­ ì¤€ë¹„": {
      "main": [[{ "node": "@misra-agent 1ì°¨ ì‹œë„", "type": "main", "index": 0 }]]
    },
    "@misra-agent 1ì°¨ ì‹œë„": {
      "main": [[{ "node": "1ì°¨ ê²°ê³¼ í™•ì¸", "type": "main", "index": 0 }]]
    },
    "1ì°¨ ê²°ê³¼ í™•ì¸": {
      "main": [[{ "node": "1ì°¨ í•´ê²°?", "type": "main", "index": 0 }]]
    },
    "1ì°¨ í•´ê²°?": {
      "main": [
        [{ "node": "Telegram í•´ê²° ì•Œë¦¼",  "type": "main", "index": 0 }],
        [{ "node": "@misra-agent 2ì°¨ ì‹œë„", "type": "main", "index": 0 }]
      ]
    },
    "@misra-agent 2ì°¨ ì‹œë„": {
      "main": [[{ "node": "2ì°¨ ê²°ê³¼ í™•ì¸", "type": "main", "index": 0 }]]
    },
    "2ì°¨ ê²°ê³¼ í™•ì¸": {
      "main": [[{ "node": "2ì°¨ í•´ê²°?", "type": "main", "index": 0 }]]
    },
    "2ì°¨ í•´ê²°?": {
      "main": [
        [{ "node": "Telegram í•´ê²° ì•Œë¦¼",    "type": "main", "index": 0 }],
        [{ "node": "@architect ì—ìŠ¤ì»¬ë ˆì´ì…˜", "type": "main", "index": 0 }]
      ]
    },
    "@architect ì—ìŠ¤ì»¬ë ˆì´ì…˜": {
      "main": [[{ "node": "Telegram ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì•Œë¦¼", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": { "executionOrder": "v1" },
  "tags": [{ "name": "embedded-lab" }, { "name": "misra" }, { "name": "escalation" }]
}
