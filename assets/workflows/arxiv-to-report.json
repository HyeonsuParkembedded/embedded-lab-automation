{
  "name": "arxiv-to-report",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "triggerAtHour": 8, "triggerAtMinute": 5 }] }
      },
      "id": "node-schedule",
      "name": "Schedule (08:05)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "command": "cat /tmp/arxiv_latest.json 2>/dev/null | head -c 8000 || echo '[]'"
      },
      "id": "node-read-arxiv",
      "name": "arXiv ìºì‹œ ì½ê¸°",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [420, 300]
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.first().json.stdout || '[]';\nlet papers;\ntry { papers = JSON.parse(raw); } catch(e) { papers = []; }\n\nif (papers.length === 0) {\n  return [{ json: { skip: true, reason: 'arXiv ë°ì´í„° ì—†ìŒ' } }];\n}\n\nconst date = new Date().toISOString().slice(0,10).replace(/-/g,'');\nconst reportPath = `{{ $env.INSTALL_DIR }}/reports/papers_${date}.pdf`;\nconst paperList = papers.slice(0, 10).map((p, i) =>\n  `${i+1}. ${p.title}\\n   ì €ì: ${(p.authors||[]).slice(0,3).join(', ')}\\n   ë§í¬: ${p.url||''}`\n).join('\\n\\n');\n\nconst prompt = `ì˜¤ëŠ˜(${date}) ìˆ˜ì§‘ëœ arXiv ë…¼ë¬¸ ëª©ë¡ì„ í•œêµ­ì–´ë¡œ ìš”ì•½í•œ PDF ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì¤˜.\\n\\në…¼ë¬¸ ëª©ë¡ (${papers.length}í¸):\\n${paperList}\\n\\nê° ë…¼ë¬¸ì— ëŒ€í•´:\\n- ì œëª© (í•œêµ­ì–´ ë²ˆì—­)\\n- ì €ì\\n- í•µì‹¬ ê¸°ì—¬ (2~3ë¬¸ì¥ í•œêµ­ì–´ ìš”ì•½)\\n- ì—°êµ¬ì†Œ ì ìš© ê°€ëŠ¥ì„± (ESP32/STM32/Zephyr/cFS ê´€ë ¨ì„±)\\n\\nì¶œë ¥ ê²½ë¡œ: ${reportPath}\\nreportlabìœ¼ë¡œ PDFë¥¼ ìƒì„±í•˜ê³  ì™„ë£Œ í›„ 'ë…¼ë¬¸ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: ${reportPath}' ë¼ê³  ì‘ë‹µí•´ì¤˜.`;\n\nreturn [{ json: { papers, reportPath, date, paperCount: papers.length, prompt, skip: false } }];"
      },
      "id": "node-prepare-prompt",
      "name": "ë…¼ë¬¸ ìš”ì•½ ìš”ì²­ ì¤€ë¹„",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [640, 300]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "check-skip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "true" }
            }
          ]
        }
      },
      "id": "node-check-data",
      "name": "ë°ì´í„° ìˆìŒ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [860, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:8080/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type",  "value": "application/json" },
            { "name": "Authorization", "value": "Bearer dummy" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"reporter\",\n  \"messages\": [{\"role\": \"user\", \"content\": \"{{ $json.prompt }}\"}],\n  \"stream\": false\n}",
        "options": { "timeout": 600000 }
      },
      "id": "node-call-reporter",
      "name": "@reporter ë…¼ë¬¸ ìš”ì•½ ìš”ì²­",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1080, 200]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "ğŸ“š *arXiv ë…¼ë¬¸ ìš”ì•½ ë¦¬í¬íŠ¸*\n\nì˜¤ëŠ˜ ìˆ˜ì§‘: {{ $('ë…¼ë¬¸ ìš”ì•½ ìš”ì²­ ì¤€ë¹„').item.json.paperCount }}í¸\nğŸ“„ ë¦¬í¬íŠ¸: `{{ $('ë…¼ë¬¸ ìš”ì•½ ìš”ì²­ ì¤€ë¹„').item.json.reportPath }}`\n\n{{ $json.choices[0].message.content.substring(0, 800) }}",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "node-telegram-report",
      "name": "Telegram ë…¼ë¬¸ ìš”ì•½ ì „ì†¡",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1300, 200],
      "credentials": { "telegramApi": { "id": "telegram-cred", "name": "Telegram Bot" } }
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "â„¹ï¸ arXiv ë¦¬í¬íŠ¸ ìŠ¤í‚µ â€” ì˜¤ëŠ˜ ìˆ˜ì§‘ëœ ë…¼ë¬¸ ì—†ìŒ",
        "additionalFields": {}
      },
      "id": "node-telegram-skip",
      "name": "Telegram ìŠ¤í‚µ ì•Œë¦¼",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1080, 400],
      "credentials": { "telegramApi": { "id": "telegram-cred", "name": "Telegram Bot" } }
    }
  ],
  "connections": {
    "Schedule (08:05)": {
      "main": [[{ "node": "arXiv ìºì‹œ ì½ê¸°", "type": "main", "index": 0 }]]
    },
    "arXiv ìºì‹œ ì½ê¸°": {
      "main": [[{ "node": "ë…¼ë¬¸ ìš”ì•½ ìš”ì²­ ì¤€ë¹„", "type": "main", "index": 0 }]]
    },
    "ë…¼ë¬¸ ìš”ì•½ ìš”ì²­ ì¤€ë¹„": {
      "main": [[{ "node": "ë°ì´í„° ìˆìŒ?", "type": "main", "index": 0 }]]
    },
    "ë°ì´í„° ìˆìŒ?": {
      "main": [
        [{ "node": "Telegram ìŠ¤í‚µ ì•Œë¦¼", "type": "main", "index": 0 }],
        [{ "node": "@reporter ë…¼ë¬¸ ìš”ì•½ ìš”ì²­", "type": "main", "index": 0 }]
      ]
    },
    "@reporter ë…¼ë¬¸ ìš”ì•½ ìš”ì²­": {
      "main": [[{ "node": "Telegram ë…¼ë¬¸ ìš”ì•½ ì „ì†¡", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": { "executionOrder": "v1" },
  "tags": [{ "name": "embedded-lab" }, { "name": "arxiv" }, { "name": "report" }]
}
