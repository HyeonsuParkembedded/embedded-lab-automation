{
  "name": "nightly-report",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "triggerAtHour": 1, "triggerAtMinute": 0 }] }
      },
      "id": "node-schedule",
      "name": "Schedule (01:00)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "command": "cat /tmp/build_status.json 2>/dev/null || echo '{\"state\":\"unknown\",\"gate\":0,\"reason\":\"ìƒíƒœ íŒŒì¼ ì—†ìŒ\",\"timestamp\":\"-\"}'"
      },
      "id": "node-read-status",
      "name": "ë¹Œë“œ ìƒíƒœ ì½ê¸°",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [420, 300]
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.first().json.stdout || '{}';\nlet status;\ntry { status = JSON.parse(raw); } catch(e) { status = { state: 'parse_error', gate: 0, reason: raw, timestamp: '-' }; }\n\nconst date = new Date().toISOString().slice(0,10).replace(/-/g,'');\nconst reportPath = `{{ $env.INSTALL_DIR }}/reports/build_${date}.pdf`;\nconst logPath = `/tmp/nightly_build_${date}.log`;\n\nconst prompt = `ì•¼ê°„ ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆì–´. ë‹¤ìŒ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¹Œë“œ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì¤˜.\\n\\në¹Œë“œ ìƒíƒœ:\\n\\`\\`\\`json\\n${JSON.stringify(status, null, 2)}\\n\\`\\`\\`\\n\\në¡œê·¸ íŒŒì¼: ${logPath}\\nì¶œë ¥ ê²½ë¡œ: ${reportPath}\\n\\nreportlabìœ¼ë¡œ PDFë¥¼ ìƒì„±í•˜ê³ , ìƒì„± ì™„ë£Œ í›„ 'ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: ${reportPath}' ë¼ê³  ì‘ë‹µí•´ì¤˜.`;\n\nreturn [{ json: { status, reportPath, logPath, date, prompt } }];"
      },
      "id": "node-prepare-report",
      "name": "ë¦¬í¬íŠ¸ ìš”ì²­ ì¤€ë¹„",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [640, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:8080/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type",  "value": "application/json" },
            { "name": "Authorization", "value": "Bearer dummy" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"reporter\",\n  \"messages\": [{\"role\": \"user\", \"content\": \"{{ $json.prompt }}\"}],\n  \"stream\": false\n}",
        "options": { "timeout": 300000 }
      },
      "id": "node-call-reporter",
      "name": "@reporter í˜¸ì¶œ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [860, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst content = response?.choices?.[0]?.message?.content || 'ì‘ë‹µ ì—†ìŒ';\nconst status = $('ë¦¬í¬íŠ¸ ìš”ì²­ ì¤€ë¹„').item.json.status;\nconst reportPath = $('ë¦¬í¬íŠ¸ ìš”ì²­ ì¤€ë¹„').item.json.reportPath;\n\nconst stateEmoji = status.state === 'completed' ? 'âœ…' : 'âŒ';\nconst summary = `${stateEmoji} *ì•¼ê°„ ë¹Œë“œ ë¦¬í¬íŠ¸*\\n\\nìƒíƒœ: ${status.state?.toUpperCase()}\\nìµœì¢… Gate: ${status.gate}\\nì‹œê°: ${status.timestamp}\\n\\nğŸ“„ ë¦¬í¬íŠ¸: \\`${reportPath}\\``;\n\nreturn [{ json: { summary, content, reportPath } }];"
      },
      "id": "node-parse-response",
      "name": "ì‘ë‹µ íŒŒì‹±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1080, 300]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "release",
        "operation": "create",
        "owner": "={{ $env.GITHUB_OWNER }}",
        "repository": "={{ $env.GITHUB_REPO }}",
        "tag": "nightly-{{ $('ë¦¬í¬íŠ¸ ìš”ì²­ ì¤€ë¹„').item.json.date }}",
        "name": "Nightly Build {{ $('ë¦¬í¬íŠ¸ ìš”ì²­ ì¤€ë¹„').item.json.date }}",
        "body": "={{ $json.content.substring(0, 1000) }}"
      },
      "id": "node-github-release",
      "name": "GitHub Release ì—…ë¡œë“œ",
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [1300, 200],
      "credentials": { "githubOAuth2Api": { "id": "github-cred", "name": "GitHub OAuth2" } }
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "={{ $('ì‘ë‹µ íŒŒì‹±').item.json.summary }}",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "node-telegram",
      "name": "Telegram ë¦¬í¬íŠ¸ ì•Œë¦¼",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1300, 400],
      "credentials": { "telegramApi": { "id": "telegram-cred", "name": "Telegram Bot" } }
    }
  ],
  "connections": {
    "Schedule (01:00)": {
      "main": [[{ "node": "ë¹Œë“œ ìƒíƒœ ì½ê¸°", "type": "main", "index": 0 }]]
    },
    "ë¹Œë“œ ìƒíƒœ ì½ê¸°": {
      "main": [[{ "node": "ë¦¬í¬íŠ¸ ìš”ì²­ ì¤€ë¹„", "type": "main", "index": 0 }]]
    },
    "ë¦¬í¬íŠ¸ ìš”ì²­ ì¤€ë¹„": {
      "main": [[{ "node": "@reporter í˜¸ì¶œ", "type": "main", "index": 0 }]]
    },
    "@reporter í˜¸ì¶œ": {
      "main": [[{ "node": "ì‘ë‹µ íŒŒì‹±", "type": "main", "index": 0 }]]
    },
    "ì‘ë‹µ íŒŒì‹±": {
      "main": [
        [{ "node": "GitHub Release ì—…ë¡œë“œ", "type": "main", "index": 0 }],
        [{ "node": "Telegram ë¦¬í¬íŠ¸ ì•Œë¦¼", "type": "main", "index": 0 }]
      ]
    }
  },
  "active": false,
  "settings": { "executionOrder": "v1" },
  "tags": [{ "name": "embedded-lab" }, { "name": "report" }]
}
